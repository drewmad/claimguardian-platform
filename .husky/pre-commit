
# Pre-commit hook with progressive checks
echo "ğŸš€ Running pre-commit checks..."

# 1. Ensure lockfile is in sync
echo "ğŸ”’ Checking lockfile..."
if [ -f "scripts/sync-lockfile.js" ]; then
  node scripts/sync-lockfile.js --fix --stage || true
fi

# 2. Run dependency check
echo "ğŸ“¦ Validating dependencies..."
pnpm deps:check || {
  echo "âŒ Dependency check failed. Your pnpm-lock.yaml is out of sync."
  echo "   Please run 'pnpm install' and then commit your changes."
  exit 1
}

# 3. Auto-fix lint issues (but don't block on failures)
echo "ğŸ”§ Auto-fixing code style..."
if [ -f "scripts/auto-fix-lint.js" ]; then
  node scripts/auto-fix-lint.js || true
fi

# 4. Run TypeScript type check
echo "ğŸ” TypeScript type checking..."
if pnpm typecheck 2>&1 | tee ts-errors.log; then
  echo "âœ… No TypeScript errors found"
  rm -f ts-errors.log
else
  echo "âš ï¸  TypeScript errors found:"
  if [ -f "ts-errors.log" ]; then
    ERROR_COUNT=$(wc -l < ts-errors.log)
    echo "   Total errors: $ERROR_COUNT"
    echo "   Run 'pnpm typecheck:group' to see error summary"
    echo "   Run 'pnpm validate' to see all issues"
  fi
  echo "   Continuing with commit (will be caught in CI)..."
fi

# 5. Database checks if Supabase is running
if command -v supabase >/dev/null 2>&1 && supabase status 2>/dev/null | grep -q "API URL"; then
  echo "ğŸ—„ï¸  Checking database..."
  cd apps/web 2>/dev/null && pnpm db:lint 2>/dev/null || true
  cd - >/dev/null 2>&1
fi

echo "âœ… Pre-commit checks complete!"
echo ""
echo "ğŸ’¡ Note: Some lint warnings may remain. Fix them in future commits."
